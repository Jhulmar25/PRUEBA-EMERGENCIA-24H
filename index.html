<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Serenazgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ‚úÖ Adaptado a m√≥vil -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f7f7f7; margin:0; }
    h2 { font-size: 22px; margin-top: 20px; }
    button {
      font-size: 24px; font-weight: bold;
      padding: 20px; margin-top: 40px;
      background: red; color: white;
      border:none; border-radius: 12px; cursor: pointer;
      width: 80%;
    }
    #qr-reader { width: 100%; max-width: 360px; margin: 20px auto; display:none; }
    #resultado { font-size: 20px; margin-top: 20px; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üö® Registro de Serenos</h2>

  <!-- Bot√≥n de inicio -->
  <button id="btnRegistro" onclick="iniciarEscaneo()">Iniciar Registro</button>

  <!-- C√°mara -->
  <div id="qr-reader"></div>

  <!-- Resultado -->
  <div id="resultado"></div>

  <script>
    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let scanner;

    // üîπ Inicia escaneo
    function iniciarEscaneo() {
      document.getElementById("btnRegistro").style.display = "none"; // ocultar bot√≥n
      document.getElementById("qr-reader").style.display = "block";  // mostrar c√°mara

      scanner = new Html5Qrcode("qr-reader");
      scanner.start(
        { facingMode: "environment" }, // ‚úÖ c√°mara trasera por defecto
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          guardarRegistro(decodedText);
          scanner.stop();
          document.getElementById("qr-reader").style.display = "none";
          document.getElementById("btnRegistro").style.display = "block"; // volver a mostrar bot√≥n
        }
      );
    }

    // üîπ Guardar en Firestore por fecha/hora
    function guardarRegistro(decodedText) {
      let datos = decodedText.split("|");
      if (datos.length < 3) {
        alert("‚ö†Ô∏è QR inv√°lido");
        return;
      }

      let dni = datos[0];
      let nombre = datos[1];
      let cargo = datos[2];

      // Fecha y hora local
      let now = new Date();
      let fecha = now.toLocaleDateString("es-PE").replace(/\//g, "-"); // dd-mm-yy
      let hora = now.toLocaleTimeString("es-PE").replace(/:/g, "-");   // hh-mm-ss

      db.collection("registros")
        .doc(fecha)              // carpeta por fecha
        .collection(hora)        // subcarpeta por hora
        .add({
          dni: dni,
          nombre: nombre,
          cargo: cargo,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById("resultado").innerHTML =
            "‚úÖ " + nombre + " (" + cargo + ") registrado";
        })
        .catch((err) => {
          console.error(err);
          alert("‚ùå Error al guardar en Firebase");
        });
    }
  </script>
</body>
</html>
