<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Serenazgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --rojo: #d32f2f;
      --gris: #555;
      --bg: #f4f4f4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      display: flex; min-height: 100vh; align-items: center; justify-content: center;
    }
    .wrap {
      width: 100%; max-width: 560px; padding: 24px; text-align: center;
    }
    h1 {
      margin: 0 0 12px; font-size: 28px; color: var(--rojo);
    }
    p.subtitle { margin: 0 0 18px; color: #333; }
    .card {
      background: #fff; border-radius: 16px; padding: 18px;
      box-shadow: 0 8px 28px rgba(0,0,0,.08);
    }
    .btn {
      width: 100%; max-width: 320px; margin: 10px auto; display: inline-block;
      padding: 16px 18px; font-size: 18px; font-weight: 700; letter-spacing:.2px;
      border: 0; border-radius: 12px; cursor: pointer;
      transition: transform .04s ease, opacity .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-start { background: var(--rojo); color: #fff; }
    .btn-stop  { background: var(--gris); color: #fff; display: none; }
    .controls { display: none; gap: 10px; justify-content: center; align-items: center; margin: 10px 0 0; }
    .controls .btn-small {
      padding: 10px 14px; font-size: 14px; border-radius: 10px; border: 0; cursor: pointer;
      background: #222; color: #fff;
    }
    .controls .slider {
      -webkit-appearance: none; appearance: none; width: 180px; height: 8px; border-radius: 8px;
      background: #e5e5e5; outline: none;
    }
    video {
      width: 100%; max-width: 520px; aspect-ratio: 16/9; background: #000;
      border-radius: 14px; margin: 12px auto; display: none;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
    }
    #resultado {
      margin-top: 8px; font-weight: 700; color: #147a22; min-height: 24px;
    }
    .hint { color:#666; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üö® Iniciar Registro</h1>
    <p class="subtitle">Apunta el c√≥digo (formato: <b>dni,nombre,cargo</b>)</p>

    <div class="card">
      <button id="btnIniciar" class="btn btn-start">Iniciar Registro</button>

      <video id="preview" playsinline></video>

      <div class="controls" id="extraControls">
        <button id="btnTorch" class="btn-small" style="display:none;">üî¶ Linterna</button>
        <input id="zoomSlider" class="slider" type="range" min="1" max="1" step="0.1" value="1" style="display:none;" />
      </div>

      <button id="btnFinalizar" class="btn btn-stop">Finalizar</button>

      <div id="resultado"></div>
      <div class="hint">Si no abre la c√°mara, abre el enlace con <b>HTTPS</b> (o localhost) y otorga permisos.</div>
    </div>
  </div>

  <!-- ZXing: import ESM desde CDN -->
  <script type="module">
    import {
      BrowserQRCodeReader,
      BrowserCodeReader
    } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

    // ‚öôÔ∏è Firebase config (pon los valores reales de tu proyecto)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UI refs
    const btnIniciar   = document.getElementById('btnIniciar');
    const btnFinalizar = document.getElementById('btnFinalizar');
    const video        = document.getElementById('preview');
    const resultado    = document.getElementById('resultado');
    const btnTorch     = document.getElementById('btnTorch');
    const zoomSlider   = document.getElementById('zoomSlider');
    const extraControls= document.getElementById('extraControls');

    // ZXing
    const reader = new BrowserQRCodeReader();
    let controls = null;
    let currentTrack = null;
    let torchOn = false;

    // Evita duplicados por lecturas seguidas
    let lastText = "";
    let lastTime = 0;

    btnIniciar.addEventListener('click', iniciar);
    btnFinalizar.addEventListener('click', finalizar);
    btnTorch.addEventListener('click', toggleTorch);
    zoomSlider.addEventListener('input', applyZoom);

    async function iniciar() {
      btnIniciar.style.display = 'none';
      btnFinalizar.style.display = 'inline-block';
      video.style.display = 'block';
      extraControls.style.display = 'flex';
      resultado.textContent = "";

      try {
        // Elegir c√°mara posterior
        const devices = await BrowserCodeReader.listVideoInputDevices();
        let deviceId = null;

        // Si hay labels, intenta detectar la trasera
        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        if (back) deviceId = back.deviceId;
        else if (devices[1]) deviceId = devices[1].deviceId;
        else if (devices[0]) deviceId = devices[0].deviceId;

        // Iniciar decodificaci√≥n desde la c√°mara elegida
        controls = await reader.decodeFromVideoDevice(deviceId, video, (result, err, _controls) => {
          if (result) {
            const text = result.getText();
            const now = Date.now();
            // Ignora lecturas repetidas en < 1.5 s
            if (text === lastText && (now - lastTime) < 1500) return;
            lastText = text; lastTime = now;

            navigator.vibrate?.(80);
            guardarRegistro(text);
          }
        });

        // Acceso a track para linterna/zoom
        const stream = video.srcObject;
        if (stream && stream.getVideoTracks().length) {
          currentTrack = stream.getVideoTracks()[0];
          setupTorchAndZoom(currentTrack);
        }
      } catch (e) {
        resultado.style.color = "#b00020";
        resultado.textContent = "‚ùå No se pudo abrir la c√°mara: " + e;
        btnFinalizar.style.display = 'none';
        btnIniciar.style.display = 'inline-block';
        video.style.display = 'none';
        extraControls.style.display = 'none';
      }
    }

    async function finalizar() {
      try {
        await controls?.stop();
      } catch(e) {}
      // Apaga la c√°mara completamente
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
      }
      video.srcObject = null;
      currentTrack = null;
      btnFinalizar.style.display = 'none';
      btnIniciar.style.display = 'inline-block';
      video.style.display = 'none';
      extraControls.style.display = 'none';
      resultado.style.color = "#147a22";
      if (!resultado.textContent) resultado.textContent = "‚õî Escaneo detenido";
    }

    function setupTorchAndZoom(track) {
      const caps = track.getCapabilities?.() || {};
      // Linterna
      if (caps.torch) {
        btnTorch.style.display = 'inline-block';
      } else {
        btnTorch.style.display = 'none';
      }
      // Zoom
      if (typeof caps.zoom === 'number' || (caps.zoom && caps.zoom.max)) {
        const min = caps.zoom.min ?? 1;
        const max = caps.zoom.max ?? 1;
        zoomSlider.min = min;
        zoomSlider.max = max;
        zoomSlider.step = (max - min) / 20 || 0.1;
        zoomSlider.value = Math.min(Math.max(1, min), max);
        zoomSlider.style.display = 'inline-block';
      } else {
        zoomSlider.style.display = 'none';
      }
    }

    async function toggleTorch() {
      if (!currentTrack) return;
      try {
        torchOn = !torchOn;
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        btnTorch.textContent = torchOn ? "üî¶ Linterna (ON)" : "üî¶ Linterna";
      } catch (e) {
        console.warn("Torch no soportada:", e);
        btnTorch.style.display = 'none';
      }
    }

    async function applyZoom() {
      if (!currentTrack) return;
      const val = Number(zoomSlider.value);
      try {
        await currentTrack.applyConstraints({ advanced: [{ zoom: val }] });
      } catch (e) {
        console.warn("Zoom no soportado:", e);
        zoomSlider.style.display = 'none';
      }
    }

    // Guardar en Firestore: registros/{dd-mm-yy}/{HH-mm-ss}/autoId
    function guardarRegistro(decodedText) {
      const partes = decodedText.split(",");
      if (partes.length < 3) {
        resultado.style.color = "#b00020";
        resultado.textContent = "‚ö†Ô∏è QR inv√°lido. Formato: dni,nombre,cargo";
        return;
      }

      const dni = partes[0].trim();
      const nombre = partes[1].trim();
      const cargo = partes[2].trim();

      const now = new Date();
      const fecha = new Intl.DateTimeFormat("es-PE", { timeZone: "America/Lima" })
        .format(now).replace(/\//g, "-"); // dd-mm-yy
      const hora = new Intl.DateTimeFormat("es-PE", {
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false, timeZone: "America/Lima"
      }).format(now).replace(/:/g, "-"); // HH-mm-ss

      db.collection("registros")
        .doc(fecha)
        .collection(hora)
        .add({
          dni, nombre, cargo,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          resultado.style.color = "#147a22";
          resultado.textContent = `‚úÖ ${nombre} (${cargo}) registrado`;
        })
        .catch(err => {
          console.error(err);
          resultado.style.color = "#b00020";
          resultado.textContent = "‚ùå Error al guardar en Firebase";
        });
    }
  </script>
</body>
</html>
