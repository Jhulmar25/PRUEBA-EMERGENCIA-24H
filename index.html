<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Serenazgo</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f7f7f7; }
    h2 { font-size: 28px; }
    button { font-size: 28px; padding: 20px 40px; margin-top: 50px;
             background: red; color: white; border:none; border-radius: 12px; cursor: pointer; }
    #qr-reader { width: 320px; margin: 20px auto; display:none; }
  </style>
</head>
<body>
  <h2>üö® Registro de Serenos</h2>

  <button id="btnRegistro" onclick="iniciarEscaneo()">Iniciar Registro</button>

  <div id="qr-reader"></div>
  <div id="resultado" style="font-size:20px; margin-top:20px;"></div>

  <script>
    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // üîπ Inicializar QR
    let scanner;
    function iniciarEscaneo() {
      document.getElementById("qr-reader").style.display = "block";
      scanner = new Html5Qrcode("qr-reader");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          guardarRegistro(decodedText);
          scanner.stop();
          document.getElementById("qr-reader").style.display = "none";
        }
      );
    }

    // üîπ Guardar en Firestore por fecha y hora
    function guardarRegistro(decodedText) {
      let datos = decodedText.split("|");
      if (datos.length < 3) {
        alert("‚ö†Ô∏è QR inv√°lido");
        return;
      }

      let dni = datos[0];
      let nombre = datos[1];
      let cargo = datos[2];

      // Obtener fecha y hora
      let now = new Date();
      let fecha = now.toLocaleDateString("es-PE"); // dd/mm/aa
      let hora = now.toLocaleTimeString("es-PE"); // hh:mm:ss

      db.collection("registros")
        .doc(fecha)            // carpeta por fecha
        .collection(hora)      // subcarpeta por hora
        .add({
          dni: dni,
          nombre: nombre,
          cargo: cargo,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById("resultado").innerHTML =
            "‚úÖ Registro guardado:<br>" + nombre + " (" + cargo + ")";
        })
        .catch((err) => {
          console.error(err);
          alert("‚ùå Error al guardar en Firebase");
        });
    }
  </script>
</body>
</html>
