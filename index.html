<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Serenazgo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <!-- Librer√≠a QR optimizada -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f7f7f7; margin:0; }
    h2 { font-size: 22px; margin-top: 20px; }
    button {
      font-size: 26px; font-weight: bold;
      padding: 20px; margin-top: 50px;
      background: red; color: white;
      border:none; border-radius: 12px; cursor: pointer;
      width: 85%;
    }
    #qr-reader { width: 100%; max-width: 360px; margin: 20px auto; display:none; }
    #resultado { font-size: 20px; margin-top: 20px; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üö® Registro de Serenos</h2>

  <!-- Bot√≥n principal -->
  <button id="btnRegistro" onclick="iniciarEscaneo()">Iniciar Registro</button>

  <!-- C√°mara -->
  <div id="qr-reader"></div>

  <!-- Resultado -->
  <div id="resultado"></div>

  <script>
    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let html5Qr;

    // üîπ Iniciar escaneo
    function iniciarEscaneo() {
      document.getElementById("btnRegistro").style.display = "none";
      document.getElementById("qr-reader").style.display = "block";

      html5Qr = new Html5Qrcode("qr-reader");
      html5Qr.start(
        { facingMode: "environment" }, // ‚úÖ Forzar c√°mara trasera
        { fps: 15, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          guardarRegistro(decodedText);
          html5Qr.stop().then(() => {
            document.getElementById("qr-reader").style.display = "none";
            document.getElementById("btnRegistro").style.display = "block";
          });
        },
        (errorMsg) => {
          // Silenciar errores de lectura continua
        }
      ).catch(err => {
        alert("‚ùå Error al activar la c√°mara: " + err);
        console.error(err);
      });
    }

    // üîπ Guardar en Firestore organizado por fecha y hora
    function guardarRegistro(decodedText) {
      let datos = decodedText.split(",");
      if (datos.length < 3) {
        alert("‚ö†Ô∏è QR inv√°lido. Debe tener formato: dni,nombre,cargo");
        return;
      }

      let dni = datos[0].trim();
      let nombre = datos[1].trim();
      let cargo = datos[2].trim();

      let now = new Date();
      let fecha = now.toLocaleDateString("es-PE").replace(/\//g, "-"); // dd-mm-yy
      let hora = now.toLocaleTimeString("es-PE").replace(/:/g, "-");   // hh-mm-ss

      db.collection("registros")
        .doc(fecha)              // carpeta por fecha
        .collection(hora)        // subcarpeta por hora
        .add({
          dni: dni,
          nombre: nombre,
          cargo: cargo,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          document.getElementById("resultado").innerHTML =
            "‚úÖ " + nombre + " (" + cargo + ") registrado correctamente";
        })
        .catch((err) => {
          console.error(err);
          alert("‚ùå Error al guardar en Firebase");
        });
    }
  </script>
</body>
</html>
